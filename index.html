<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PhotoBooth â€” Polaroid Maker</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111824;
      --muted: #93a2b7;
      --accent: #4f9cff;
      --accent-2: #7cf0c5;
      --mirror: 1;
      --video-filter: none;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; background: linear-gradient(135deg, #0b0f14 0%, #0f1622 100%);
      color: #e8eef7; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      min-height: 100vh; display: grid; place-items: center; padding: 16px;
    }

    .app {
      width: min(1200px, 100%);
      display: grid; gap: 16px;
    }

    header {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    .title { font-weight: 800; letter-spacing: 0.3px; font-size: clamp(20px, 2.2vw, 28px); }
    .badge { font-size: 12px; color: var(--muted); }

    .stage {
      display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px;
    }
    @media (max-width: 900px) {
      .stage { grid-template-columns: 1fr; }
    }

    .panel {
      background: radial-gradient(80% 120% at 0% 0%, #0e1522 0%, #0a0f17 60%), var(--card);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 18px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    /* Camera preview area */
    .preview-wrap { 
      position: relative; border-radius: 14px; overflow: hidden; 
      aspect-ratio: 4 / 3; background:#02060b; display:grid; place-items:center; 
    }
    video { 
      width: 100%; height: 100%; object-fit: cover; 
      transform: scaleX(var(--mirror)); filter: var(--video-filter); 
    }
    .preview-overlay { 
      position:absolute; inset:0; pointer-events:none; 
      outline: 800px solid rgba(0,0,0,0); 
    }

    /* Controls */
    .controls { display: grid; gap: 10px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }

    select, button, input[type="text"] {
      background: #0f1622; color: #e8eef7; border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px; border-radius: 12px; font-size: 14px;
    }
    button { 
      cursor: pointer; 
      transition: transform .06s ease, background .2s ease, border-color .2s ease; 
    }
    button:hover { transform: translateY(-1px); }
    .btn-primary { 
      background: linear-gradient(135deg, var(--accent), #7ea7ff); 
      border-color: transparent; color:#06101f; font-weight:700; 
    }
    .btn-ghost { background: #0d1420; }

    .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 10px; }
    .filter { 
      position: relative; padding: 0; overflow: hidden; border-radius: 12px; 
      cursor: pointer; transition: transform .15s ease;
    }
    .filter:hover { transform: scale(1.05); }
    .filter span { 
      position: absolute; left: 8px; bottom: 8px; font-size: 12px; 
      color: #dfe8f5; text-shadow: 0 1px 2px rgba(0,0,0,.6); z-index: 1;
    }

    canvas.thumb { width: 100%; height: auto; display: block; aspect-ratio: 1; }

    /* Gallery */
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 18px; }

    .polaroid {
      background: #fff; color: #111; border-radius: 10px; padding: 10px 10px 36px 10px; position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(0,0,0,.04);
      transform: rotate(calc(var(--rot, 0) * 1deg));
      transition: transform .15s ease;
    }
    .polaroid:hover { transform: rotate(calc(var(--rot, 0) * 1deg)) scale(1.02); }
    .polaroid img { 
      width: 100%; display: block; border-radius: 6px; object-fit: cover; 
      aspect-ratio: 4 / 5; background:#e7e9ee; 
    }
    .caption { 
      position: absolute; left: 0; right: 0; bottom: 8px; text-align: center; 
      font-family: "Caveat", ui-rounded, system-ui, sans-serif; font-size: 16px; 
      color: #1a1a1a; padding: 0 10px;
    }

    .p-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; }
    .icon-btn { 
      background: rgba(0,0,0,0.6); border: none; color: #fff; 
      padding: 6px 8px; border-radius: 8px; font-size: 12px; cursor: pointer; 
    }

    .hint { color: var(--muted); font-size: 13px; }
    .warn { color: #ffb4b4; }

    .error-state {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 40px 20px; text-align: center; color: var(--muted);
    }
    .error-state button {
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">ðŸ“¸ PhotoBooth â€” Polaroid Maker</div>
      <div class="badge" id="secureHint">Camera Ready</div>
    </header>

    <div class="stage">
      <!-- Left: Live camera and controls -->
      <div class="panel">
        <div class="preview-wrap">
          <video id="preview" autoplay playsinline muted></video>
          <div class="preview-overlay" id="gridOverlay" hidden></div>
          <div id="errorState" class="error-state" hidden>
            <div>ðŸ“·</div>
            <div>Camera not accessible</div>
            <div style="font-size: 12px; margin-top: 8px;">Check permissions or try HTTPS</div>
            <button id="retryBtn" class="btn-primary">Retry Camera</button>
          </div>
        </div>

        <div class="controls" style="margin-top:12px;">
          <div class="row">
            <select id="deviceSelect" title="Choose camera">
              <option>Loading cameras...</option>
            </select>
            <button id="flipBtn" class="btn-ghost">Flip Camera</button>
            <button id="mirrorBtn" class="btn-ghost">Mirror: On</button>
            <button id="gridBtn" class="btn-ghost">Grid: Off</button>
            <button id="captureBtn" class="btn-primary">Take Photo</button>
          </div>

          <div class="row">
            <span class="hint">Filter:</span>
            <div id="filterChips" class="row"></div>
          </div>

          <div class="filters" id="filterGrid"></div>
          <div class="hint" id="supportNote"></div>
        </div>
      </div>

      <!-- Right: Gallery -->
      <div class="panel">
        <div class="row" style="justify-content: space-between; align-items: baseline;">
          <div style="font-weight:700;">Polaroid Gallery</div>
          <div class="row">
            <button id="downloadAllBtn" class="btn-ghost">Download All</button>
            <button id="clearBtn" class="btn-ghost">Clear</button>
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">Tip: Click a caption to edit text.</div>
        <div class="gallery" id="gallery" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Hidden working canvas -->
  <canvas id="workCanvas" hidden></canvas>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const isSecure = window.isSecureContext || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    
    // Filters map
    const FILTERS = [
      { id: 'none', label: 'None', css: 'none' },
      { id: 'bw', label: 'B&W', css: 'grayscale(1) contrast(1.1)' },
      { id: 'sepia', label: 'Sepia', css: 'sepia(1) contrast(1.05) saturate(0.9)' },
      { id: 'vintage', label: 'Vintage', css: 'contrast(1.15) saturate(0.85) sepia(0.35) brightness(1.05)' },
      { id: 'cool', label: 'Cool', css: 'hue-rotate(190deg) saturate(1.2) contrast(1.05)' },
      { id: 'warm', label: 'Warm', css: 'sepia(0.2) saturate(1.2) brightness(1.05)' },
      { id: 'film', label: 'Film', css: 'grayscale(.2) contrast(1.2) brightness(.95) saturate(0.9)' },
    ];

    // State
    let currentStream = null;
    let currentDeviceId = null;
    let facing = 'user';
    let mirrored = true;
    let filterId = 'none';
    let devices = [];

    const video = $('#preview');
    const deviceSelect = $('#deviceSelect');
    const filterChips = $('#filterChips');
    const filterGrid = $('#filterGrid');
    const captureBtn = $('#captureBtn');
    const flipBtn = $('#flipBtn');
    const mirrorBtn = $('#mirrorBtn');
    const gridBtn = $('#gridBtn');
    const gridOverlay = $('#gridOverlay');
    const workCanvas = $('#workCanvas');
    const gallery = $('#gallery');
    const supportNote = $('#supportNote');
    const errorState = $('#errorState');
    const retryBtn = $('#retryBtn');
    const secureHint = $('#secureHint');

    // Check camera support
    function checkSupport() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        supportNote.textContent = 'Your browser does not support camera access. Try Chrome, Edge, or Safari.';
        supportNote.className = 'hint warn';
        return false;
      }
      
      if (!isSecure) {
        secureHint.textContent = 'Requires HTTPS / localhost';
        secureHint.className = 'badge warn';
        supportNote.textContent = 'Camera access requires HTTPS or localhost. Please use a secure connection.';
        supportNote.className = 'hint warn';
        return false;
      }
      
      return true;
    }

    async function listDevices() {
      try {
        const allDevices = await navigator.mediaDevices.enumerateDevices();
        devices = allDevices.filter(d => d.kind === 'videoinput');
        
        deviceSelect.innerHTML = '';
        if (devices.length === 0) {
          const opt = document.createElement('option');
          opt.textContent = 'No cameras found';
          deviceSelect.appendChild(opt);
          return;
        }

        devices.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || Camera ${i + 1};
          deviceSelect.appendChild(opt);
        });
        
        if (!currentDeviceId && devices.length > 0) {
          currentDeviceId = devices[0].deviceId;
          deviceSelect.value = currentDeviceId;
        }
      } catch (err) {
        console.error('Failed to list devices:', err);
        deviceSelect.innerHTML = '<option>Error loading cameras</option>';
      }
    }

    async function startStream() {
      try {
        // Stop previous stream
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }

        // Hide error state
        errorState.hidden = true;
        video.style.display = 'block';

        const constraints = {
          video: currentDeviceId 
            ? { deviceId: { exact: currentDeviceId } }
            : { facingMode: facing }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        
        // Wait for video to be ready
        await new Promise((resolve) => {
          video.addEventListener('loadedmetadata', resolve, { once: true });
        });
        
        secureHint.textContent = 'Camera Active';
        secureHint.className = 'badge';
        
      } catch (err) {
        console.error('Failed to start camera:', err);
        showError('Could not access camera. Check permissions or try a different device.');
      }
    }

    function showError(message) {
      video.style.display = 'none';
      errorState.hidden = false;
      errorState.querySelector('div:nth-child(2)').textContent = message;
    }

    function applyVideoFilter() {
      const found = FILTERS.find(f => f.id === filterId) || FILTERS[0];
      document.documentElement.style.setProperty('--video-filter', found.css);
    }

    function renderFilterUI() {
      // Filter chips
      filterChips.innerHTML = '';
      FILTERS.forEach(f => {
        const b = document.createElement('button');
        b.className = 'btn-ghost';
        b.textContent = f.label;
        b.dataset.filter = f.id;
        if (f.id === filterId) {
          b.style.background = 'var(--accent)';
          b.style.color = '#06101f';
        }
        b.addEventListener('click', () => {
          filterId = f.id;
          applyVideoFilter();
          renderFilterUI();
        });
        filterChips.appendChild(b);
      });

      // Filter grid thumbnails
      filterGrid.innerHTML = '';
      FILTERS.forEach(f => {
        const btn = document.createElement('button');
        btn.className = 'filter';
        btn.title = f.label;
        
        const c = document.createElement('canvas');
        c.width = 120; c.height = 120; c.className = 'thumb';
        
        // Create preview tile
        const ctx = c.getContext('2d');
        const grad = ctx.createLinearGradient(0,0,120,120);
        grad.addColorStop(0,'#ffd1d1'); 
        grad.addColorStop(.5,'#9fd8ff'); 
        grad.addColorStop(1,'#caffc9');
        ctx.fillStyle = grad; 
        ctx.fillRect(0,0,120,120);
        
        // Add some preview elements
        ctx.fillStyle = '#222'; 
        ctx.font = 'bold 14px system-ui'; 
        ctx.fillText('Aa', 10, 22);
        ctx.fillRect(16, 80, 88, 16);
        
        btn.appendChild(c);
        
        const label = document.createElement('span'); 
        label.textContent = f.label; 
        btn.appendChild(label);
        
        btn.addEventListener('click', () => { 
          filterId = f.id; 
          applyVideoFilter(); 
          renderFilterUI(); 
        });
        
        if (f.id === filterId) {
          btn.style.outline = '2px solid var(--accent)';
        }
        
        filterGrid.appendChild(btn);
      });
    }

    function randomRotation() {
      return (Math.random() * 8 - 4).toFixed(2); // -4 to +4 deg
    }

    function createPolaroid(dataURL, captionText = 'Write hereâ€¦') {
      const wrap = document.createElement('div');
      wrap.className = 'polaroid';
      wrap.style.setProperty('--rot', randomRotation());

      const img = new Image();
      img.src = dataURL; 
      img.alt = 'Snapshot';

      const caption = document.createElement('div');
      caption.className = 'caption';
      caption.contentEditable = 'true';
      caption.textContent = captionText;
      caption.addEventListener('focus', () => {
        if (caption.textContent === 'Write hereâ€¦') {
          caption.textContent = '';
        }
      });

      const actions = document.createElement('div');
      actions.className = 'p-actions';

      const btnDownload = document.createElement('button');
      btnDownload.className = 'icon-btn'; 
      btnDownload.title = 'Download'; 
      btnDownload.textContent = 'â¬‡';
      btnDownload.addEventListener('click', () => {
        const a = document.createElement('a');
        a.href = dataURL; 
        a.download = polaroid-${Date.now()}.png; 
        a.click();
      });

      const btnDelete = document.createElement('button');
      btnDelete.className = 'icon-btn'; 
      btnDelete.title = 'Delete'; 
      btnDelete.textContent = 'ðŸ—‘';
      btnDelete.addEventListener('click', () => {
        if (confirm('Delete this photo?')) {
          wrap.remove();
        }
      });

      actions.append(btnDownload, btnDelete);
      wrap.append(actions, img, caption);
      return wrap;
    }

    async function takePhoto() {
      if (!video.videoWidth || !currentStream) {
        alert('Camera not ready. Please wait for camera to load.');
        return;
      }
      
      const w = video.videoWidth;
      const h = video.videoHeight;
      const ctx = workCanvas.getContext('2d');
      workCanvas.width = w; 
      workCanvas.height = h;

      // Clear canvas
      ctx.clearRect(0, 0, w, h);
      
      // Save context state
      ctx.save();
      
      // Handle mirroring
      if (mirrored) { 
        ctx.translate(w, 0); 
        ctx.scale(-1, 1); 
      }

      // Apply filter
      const selected = FILTERS.find(f => f.id === filterId) || FILTERS[0];
      if (selected.css !== 'none') {
        ctx.filter = selected.css;
      }
      
      // Draw video frame
      ctx.drawImage(video, 0, 0, w, h);
      ctx.restore();

      // Optional vignette effect
      const grad = ctx.createRadialGradient(w/2, h/2, Math.min(w,h)/3, w/2, h/2, Math.max(w,h)/1.2);
      grad.addColorStop(0, 'rgba(0,0,0,0)');
      grad.addColorStop(1, 'rgba(0,0,0,0.12)');
      ctx.globalCompositeOperation = 'multiply';
      ctx.fillStyle = grad; 
      ctx.fillRect(0,0,w,h);
      ctx.globalCompositeOperation = 'source-over';

      const dataURL = workCanvas.toDataURL('image/png', 0.95);
      const card = createPolaroid(dataURL);
      gallery.prepend(card);
      
      // Flash effect
      captureBtn.style.transform = 'scale(0.95)';
      setTimeout(() => {
        captureBtn.style.transform = '';
      }, 100);
    }

    function downloadAll() {
      const items = $$('.polaroid img', gallery);
      if (!items.length) {
        alert('No photos to download yet.');
        return;
      }

      // Download each photo individually (simple approach)
      items.forEach((img, i) => {
        setTimeout(() => {
          const a = document.createElement('a');
          a.href = img.src; 
          a.download = polaroid-${i + 1}.png; 
          a.click();
        }, i * 200); // Stagger downloads
      });
    }

    function toggleGrid() {
      if (gridOverlay.hasAttribute('hidden')) {
        gridOverlay.removeAttribute('hidden');
        
        // Create grid overlay
        gridOverlay.innerHTML = '';
        const canvas = document.createElement('canvas');
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        canvas.style.position = 'absolute';
        canvas.style.top = '0';
        canvas.style.left = '0';
        
        // Set canvas size to match container
        const rect = gridOverlay.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 1;
        
        const w = canvas.width;
        const h = canvas.height;
        
        // Draw thirds grid
        ctx.beginPath();
        // Vertical lines
        ctx.moveTo(w/3, 0); ctx.lineTo(w/3, h);
        ctx.moveTo(2*w/3, 0); ctx.lineTo(2*w/3, h);
        // Horizontal lines
        ctx.moveTo(0, h/3); ctx.lineTo(w, h/3);
        ctx.moveTo(0, 2*h/3); ctx.lineTo(w, 2*h/3);
        ctx.stroke();
        
        gridOverlay.appendChild(canvas);
        gridBtn.textContent = 'Grid: On';
      } else {
        gridOverlay.setAttribute('hidden', '');
        gridBtn.textContent = 'Grid: Off';
      }
    }

    // ---------- Event listeners ----------
    deviceSelect.addEventListener('change', async () => {
      currentDeviceId = deviceSelect.value;
      await startStream();
    });

    flipBtn.addEventListener('click', async () => {
      // Try to switch to different camera
      if (devices.length > 1) {
        const currentIndex = devices.findIndex(d => d.deviceId === currentDeviceId);
        const nextIndex = (currentIndex + 1) % devices.length;
        currentDeviceId = devices[nextIndex].deviceId;
        deviceSelect.value = currentDeviceId;
        await startStream();
      } else {
        // Fallback: toggle facing mode
        facing = (facing === 'user') ? 'environment' : 'user';
        currentDeviceId = null;
        await startStream();
      }
    });

    mirrorBtn.addEventListener('click', () => {
      mirrored = !mirrored;
      document.documentElement.style.setProperty('--mirror', mirrored ? '1' : '-1');
      mirrorBtn.textContent = Mirror: ${mirrored ? 'On' : 'Off'};
    });

    gridBtn.addEventListener('click', toggleGrid);
    captureBtn.addEventListener('click', takePhoto);
    retryBtn.addEventListener('click', init);

    $('#clearBtn').addEventListener('click', () => {
      if (confirm('Clear all photos?')) {
        gallery.innerHTML = '';
      }
    });

    $('#downloadAllBtn').addEventListener('click', downloadAll);

    // ---------- Initialization ----------
    async function init() {
      if (!checkSupport()) {
        showError('Camera not supported');
        return;
      }

      try {
        secureHint.textContent = 'Initializing camera...';
        await listDevices();
        await startStream();
        applyVideoFilter();
        renderFilterUI();
        secureHint.textContent = 'Camera Ready';
      } catch (e) {
        console.error('Initialization failed:', e);
        showError('Failed to initialize camera');
      }
    }

    // Start when page loads
    document.addEventListener('DOMContentLoaded', init);

    // Handle visibility changes (mobile browsers pause video)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentStream && video.srcObject) {
        video.play();
      }
    });

    // Handle window resize for grid overlay
    window.addEventListener('resize', () => {
      if (!gridOverlay.hasAttribute('hidden')) {
        toggleGrid(); // Turn off
        toggleGrid(); // Turn back on with new size
      }
    });
  </script>
</body>
</html>